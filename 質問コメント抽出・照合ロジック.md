# 質問コメント抽出・照合ロジック

## 概要
ライブ配信のチャットコメントから質問コメントを抽出し、回答状況を判定するロジックをまとめたドキュメントです。

## 1. 質問コメントの抽出

### 1.1 抽出条件 (`utils/csv_processor.py::extract_questions`)

#### 1.1.1 属性による抽出
- **対象属性**:
  - 「商品に対する質問」
  - 「出演者に対する質問」
- これらの属性を持つコメントを抽出

#### 1.1.2 公式コメントの除外
以下の条件に該当するコメントは除外されます：

1. **user_typeによる除外**
   - `user_type`が"moderator"の行を除外

2. **user_idによる除外**
   - `user_id`が存在し、値が空でない行を除外

3. **guest_idによる除外**（後方互換性）
   - `guest_id`が`OFFICIAL_GUEST_ID`（"555674619"）の行を除外

4. **usernameによる除外**
   - `username`が"マツキヨココカラSTAFF"の行を除外

### 1.2 抽出フロー
```
全コメントデータ
  ↓
属性が「商品に対する質問」または「出演者に対する質問」のコメントを抽出
  ↓
公式コメントを除外（user_type、user_id、guest_id、usernameで判定）
  ↓
質問コメントのみのデータフレーム
```

## 2. AI分析による質問判定

### 2.1 質問属性の定義

#### 2.1.1 商品に対する質問
- **定義**: 商品の価格、サイズ、機能、在庫、購入方法などに関する質問
- **重要**: **情報を求めている、答えを期待しているコメントのみが質問**
- **判定条件**:
  - 疑問詞（何、いくら、どこ、いつ、どう、なぜ、どれ、どの、誰など）を含む商品関連の質問
  - 疑問符（？）を含む商品関連の質問
  - 「みたいです」「見たいです」などの要望表現で、情報を求めている場合のみ含む

- **例（質問）**:
  - 「このタンブラーはいくらですか？」
  - 「電子レンジ対応できますか？」
  - 「在庫ありますか？」
  - 「よく見せてください」
  - 「見たいです」

- **例（質問ではない）**:
  - 「早く順番こないかなー」- 要望・期待表現（情報を求めていない）
  - 「直接いらないよう」- 情報提供・断り（情報を提供している）
  - 「店内のと区別がつかないのでパートナーさんが大変そう」- 観察・感想（情報を求めていない）
  - 「アンケート答えます」- 意思表明・回答（回答する意思を表明、質問ではない）
  - 「次回はクリスマスイブイブ」- 情報提供・告知（情報を提供している）

#### 2.1.2 出演者に対する質問
- **定義**: 出演者の名前、職業、経験、意見などに関する質問
- **重要**: **情報を求めている、答えを期待しているコメントのみが質問**
- **判定条件**:
  - 疑問詞（何、いくら、どこ、いつ、どう、なぜ、どれ、どの、誰など）を含む出演者関連の質問
  - 疑問符（？）を含む出演者関連の質問

- **例（質問）**:
  - 「お名前は何ですか？」
  - 「この商品どう思いますか？」
  - 「何年使っていますか？」

- **例（質問ではない）**:
  - 「いい質問でーす」- 他者への反応・評価（他者の質問への反応、自分が質問しているわけではない）
  - 「まだかえなーい」- 状況報告・期待表現（情報を求めていない）

### 2.2 質問判定の重要ポイント

#### 2.2.1 質問かどうかの判定（最重要）
- 疑問詞や疑問符の有無だけでなく、**情報を求めているかどうか**を必ず確認
- 情報を求めている、答えを期待しているコメントのみが質問

#### 2.2.2 質問ではないもの
以下のコメントは質問ではありません：

1. **要望・期待表現**
   - 「〜かなー」「〜ないかな」など
   - 情報を求めているわけではなく、状況への期待や要望を述べている

2. **情報提供・告知**
   - 「〜です」「〜ます」など
   - 情報を提供している、質問ではなく回答

3. **状況報告・感想**
   - 「〜です」「〜そう」など
   - 状況や感想を述べている、情報を求めていない

4. **他者への反応・評価**
   - 「いい質問でーす」など
   - 他者の質問への反応、自分が質問しているわけではない

5. **意思表明・回答**
   - 「答えます」など
   - 回答する意思を表明している、質問ではない

#### 2.2.3 特殊ケース
- **「みたいです」「見たいです」**
  - 情報を求めている場合のみ「商品に対する質問」に分類
  - 単なる要望表現の場合は「その他」に分類

### 2.3 プロンプト定義

#### 2.3.1 属性分析プロンプト (`prompts/analysis_prompts.py::get_attribute_analysis_prompt`)
- 13種類の属性カテゴリから1つを選択
- 質問判定の重要ポイントを含む詳細な説明

#### 2.3.2 統合分析プロンプト (`prompts/analysis_prompts.py::get_combined_analysis_prompt`)
- 属性と感情を同時に分析
- 質問判定の重要ポイントを含む


### 3.3 部分一致判定ロジック (`utils/question_answer_matcher.py::is_question_answered`)

#### 3.3.1 処理フロー

1. **絵文字の除去**
   - Unicode範囲を使用して絵文字を除去
   - 絵文字パターン: `[\U0001F600-\U0001F64F\U0001F300-\U0001F5FF\U0001F680-\U0001F6FF\U0001F1E0-\U0001F1FF\U00002702-\U000027B0\U000024C2-\U0001F251]+`

2. **完全一致チェック**
   - 質問テキストと回答テキストが完全に一致する場合、Trueを返す

3. **包含チェック**
   - 一方がもう一方に完全に含まれている場合、Trueを返す

4. **短い質問の処理**
   - 3文字以下の質問は、完全一致または部分一致のみで判定
   - 質問の主要なキーワードが回答に含まれているかチェック

5. **日本語テキストの照合**
   - 日本語文字（ひらがな、カタカナ、漢字）と英数字を抽出
   - パターン: `[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF\w]+`
   - 質問のキーワードが回答に含まれているかチェック
   - 一致率を計算（閾値：0.1）

6. **AI分析による補完**
   - 文字列マッチングで判定できない場合（閾値未満）、AI分析を試す
   - 短いテキスト（3文字以下）の場合はAI分析をスキップ
   - プロンプト: `get_question_answer_match_prompt`



### 4.2 統計情報セクション
- 質問件数


### 4.3 データ処理
- `guest_id`を削除
- `inserted_at`を「配信時間」にリネーム
- NaN値を空文字列に変換
- 回答方法が空文字列の場合、回答状況をFalseに設定

## 5. 質問統計情報の計算

### 5.1 統計項目 (`utils/google_sheets.py::calculate_question_statistics`)

1. **質問コメント件数**
   - 抽出された質問コメントの総数


## 6. 主要な関数一覧

### 6.1 質問抽出
- `extract_questions` (`utils/csv_processor.py`): 質問コメントを抽出（公式コメントは除外）


### 6.4 統計計算
- `calculate_question_statistics` (`utils/google_sheets.py`): 質問統計情報を計算

## 7. データフロー（質問関連）

```
全コメントデータ
  ↓
AI分析（属性・感情判定）
  ↓
extract_questions（質問コメント抽出）
  ↓
公式コメント除外
  ↓
質問コメントデータ
  ↓
質問CSV出力（回答状況、回答方法を含む）
```

## 8. 注意事項

### 8.1 質問判定の精度
- 情報を求めているかどうかを必ず確認
- 疑問詞や疑問符の有無だけでなく、文脈を考慮
- 要望・期待表現、情報提供、状況報告などは質問ではない

### 8.2 公式コメントの除外
- 複数の条件で公式コメントを判定（user_type、user_id、guest_id、username）
- 質問コメント抽出時に公式コメントを除外

### 8.4 部分一致の閾値
- 一致率の閾値: 0.1（10%）
- 短い質問（3文字以下）は完全一致または部分一致のみで判定

